package testUI;

import apiClient.FactoryRequest;
import io.qameta.allure.Attachment;
import io.qameta.allure.Description;
import io.qameta.allure.Owner;
import io.qameta.allure.Step;
import io.qameta.allure.junit4.DisplayName;
import io.restassured.response.Response;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;

public class VulnerabilityTest {

    String globalIdScan="";
    @Before
    public void before(){}


     @Test
     @DisplayName("Verify the vulnerability test using OWASP")
     @Description("This test case is to verify the attack of vulnerability using owasp with the last pluggins")
     @Owner("Kevin Herrera")
     public void verifyVulnerabilityScanTest() throws InterruptedException {
         globalIdScan=startScanningOWASPZAP();
         monitoringStateAttack(globalIdScan);
     }

    @After
    public void after(){
        generateReportOWASP();
    }

    @Attachment(value ="{0}", type="text/html")
    public static String attachHTMLFile(String name,String html){
        return html;
    }


    @Step("Start Vulnerability Test using OWASP ZAP")
     public String startScanningOWASPZAP(){
         // iniciar el scan ------> obtener ID
         String startScanUrl="http://127.0.0.1:8888/JSON/ascan/action/scan/?url=\"https://todoist.com\"&recurse=&inScopeOnly=&scanPolicyName=&method=&postData=&contextId=";
         Response response=FactoryRequest.make("get").send(startScanUrl);
         response.prettyPrint();
         String scanId=response.then().extract().path("scan");
         System.out.println("ID :"+scanId);
         return scanId;
     }

     @Step("Monitoring Scan of OWASP ZAP 100%")
     public void monitoringStateAttack(String scanId) throws InterruptedException {
         // preguntar si termino el scan y llego al  100%  ---> ID
         String getStateUrl="http://127.0.0.1:8888/JSON/ascan/view/status/?scanId="+scanId;
         String isComplete="";
         while (!isComplete.equals("100") ){
             Thread.sleep(30000);
             Response responseStatus=FactoryRequest.make("get").send(getStateUrl);
             isComplete=responseStatus.then().extract().path("status");
             System.out.println("OWASP Status : "+isComplete+" %");
         }
     }

     public void generateReportOWASP(){
         String getReportHTML="http://127.0.0.1:8888/OTHER/core/other/htmlreport/";
         Response responseReport=FactoryRequest.make("get").send(getReportHTML);
         String htmlReport=responseReport.body().asString();
         attachHTMLFile("OWASP Report Vulnerability Detail",htmlReport);

         String getSummaryReportHMTL="http://127.0.0.1:8888/HTML/ascan/view/scanProgress/?scanId="+globalIdScan;
         responseReport=FactoryRequest.make("get").send(getSummaryReportHMTL);
         String htmlSumaryReport=responseReport.body().asString();
         attachHTMLFile("OWASP Summary Report ",htmlSumaryReport);
     }

}
